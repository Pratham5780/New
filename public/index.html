<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Management Website</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Welcome to the Event Management Website</h1>
    <button id="addButton">Add Event</button>

    <div id="formContainer" style="display: none;">
        <h2>Add New Event</h2>
        <form id="eventForm">
            <label for="courseName">Course Name:</label>
            <input type="text" id="courseName" name="courseName" required><br>

            <label for="duration">Duration:</label>
            <input type="text" id="duration" name="duration" required><br>

            <label for="startTime">Start Time:</label>
            <input type="time" id="startTime" name="startTime" required><br>

            <label for="endTime">End Time:</label>
            <input type="time" id="endTime" name="endTime" required><br>

            <label for="trainerName">Trainer Name:</label>
            <input type="text" id="trainerName" name="trainerName" required><br>

            <label for="syllabusLink">Syllabus Link:</label>
            <input type="url" id="syllabusLink" name="syllabusLink" required><br>

            <label for="meetingLink">Meeting Link:</label>
            <input type="url" id="meetingLink" name="meetingLink" required><br>

            <label for="studentInfoLink">Student Info Link:</label>
            <input type="url" id="studentInfoLink" name="studentInfoLink" required><br>

            <button type="submit">Submit</button>
        </form>
    </div>

    <div id="editFormContainer" style="display: none;">
        <h2>Edit Event</h2>
        <form id="editForm">
            <label for="editCourseName">Course Name:</label>
            <input type="text" id="editCourseName" name="courseName" required><br>

            <label for="editDuration">Duration:</label>
            <input type="text" id="editDuration" name="duration" required><br>

            <label for="editStartTime">Start Time:</label>
            <input type="time" id="editStartTime" name="startTime" required><br>

            <label for="editEndTime">End Time:</label>
            <input type="time" id="editEndTime" name="endTime" required><br>

            <label for="editTrainerName">Trainer Name:</label>
            <input type="text" id="editTrainerName" name="trainerName" required><br>

            <label for="editSyllabusLink">Syllabus Link:</label>
            <input type="url" id="editSyllabusLink" name="syllabusLink" required><br>

            <label for="editMeetingLink">Meeting Link:</label>
            <input type="url" id="editMeetingLink" name="meetingLink" required><br>

            <label for="editStudentInfoLink">Student Info Link:</label>
            <input type="url" id="editStudentInfoLink" name="studentInfoLink" required><br>

            <button type="submit">Update</button>
        </form>
    </div>

    <div id="eventTableContainer">
        <h2>Event List</h2>
        <table id="eventTable">
            <thead>
                <tr>
                    <th>Serial Number</th>
                    <th>Course Name</th>
                    <th>Duration</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Trainer Name</th>
                    <th>Syllabus Link</th>
                    <th>Meeting Link</th>
                    <th>Student Info Link</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="eventTableBody">
                <!-- Data rows will be inserted here -->
            </tbody>
        </table>
    </div>

    <script>
        const addButton = document.getElementById("addButton");
        const formContainer = document.getElementById("formContainer");
        const editFormContainer = document.getElementById('editFormContainer');
        const eventForm = document.getElementById("eventForm");
        const eventTableBody = document.getElementById('eventTableBody');

        addButton.addEventListener("click", function () {
            const isVisible = addButton.getAttribute("data-visible") === "true";
            if (isVisible) {
                formContainer.style.display = "none";
                editFormContainer.style.display = "none";
                addButton.setAttribute("data-visible", "false");
            } else {
                formContainer.style.display = "block";
                addButton.setAttribute("data-visible", "true");
            }
        });

        eventForm.addEventListener("submit", async function (event) {
            event.preventDefault();

            const formData = new FormData(eventForm);
            const formDataObject = {
                courseName: formData.get('courseName'),
                duration: formData.get('duration'),
                startTime: formData.get('startTime'),
                endTime: formData.get('endTime'),
                trainerName: formData.get('trainerName'),
                syllabusLink: formData.get('syllabusLink'),
                meetingLink: formData.get('meetingLink'),
                studentInfoLink: formData.get('studentInfoLink')
            };

            try {
                const response = await fetch("/submit", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(formDataObject),
                });

                if (response.ok) {
                    formContainer.style.display = "none";
                    loadEvents();
                    eventForm.reset(); // Reset the form
                } else {
                    console.error("Error submitting data.");
                }
            } catch (error) {
                console.error("An error occurred while submitting data.", error);
            }
        });

        function createEditButton(event) {
            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.addEventListener('click', () => openEditForm(event));
            return editButton;
        }

        function createDeleteButton(event) {
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.addEventListener('click', async () => {
                try {
                    const response = await fetch(`/delete/${event._id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        loadEvents();
                    } else {
                        console.error('Error deleting event.');
                    }
                } catch (error) {
                    console.error('An error occurred while deleting event.', error);
                }
            });
            return deleteButton;
        }

        async function openEditForm(event) {
            editFormContainer.style.display = "block";

            const editForm = document.getElementById('editForm');
            const editCourseName = document.getElementById('editCourseName');
            const editDuration = document.getElementById('editDuration');
            const editStartTime = document.getElementById('editStartTime');
            const editEndTime = document.getElementById('editEndTime');
            const editTrainerName = document.getElementById('editTrainerName');
            const editSyllabusLink = document.getElementById('editSyllabusLink');
            const editMeetingLink = document.getElementById('editMeetingLink');
            const editStudentInfoLink = document.getElementById('editStudentInfoLink');

            editCourseName.value = event.courseName;
            editDuration.value = event.duration;
            editStartTime.value = event.startTime;
            editEndTime.value = event.endTime;
            editTrainerName.value = event.trainerName;
            editSyllabusLink.value = event.syllabusLink;
            editMeetingLink.value = event.meetingLink;
            editStudentInfoLink.value = event.studentInfoLink;

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const updatedData = {
                    courseName: editCourseName.value,
                    duration: editDuration.value,
                    startTime: editStartTime.value,
                    endTime: editEndTime.value,
                    trainerName: editTrainerName.value,
                    syllabusLink: editSyllabusLink.value,
                    meetingLink: editMeetingLink.value,
                    studentInfoLink: editStudentInfoLink.value
                };

                try {
                    const response = await fetch(`/edit/${event._id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedData)
                    });

                    if (response.ok) {
                        editFormContainer.style.display = 'none';
                        loadEvents();
                    } else {
                        console.error('Error updating data.');
                    }
                } catch (error) {
                    console.error('An error occurred while updating data.', error);
                }
            });
        }

        function isTimeInRange(time, startTime, endTime) {
            const currentTime = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            return currentTime >= startTime && currentTime <= endTime;
        }

        // Function to update row colors based on time range
        function updateRowColors() {
            const rows = document.querySelectorAll('#eventTableBody tr');
            rows.forEach(row => {
                const startTime = row.cells[3].textContent;
                const endTime = row.cells[4].textContent;

                if (isTimeInRange(new Date(), startTime, endTime)) {
                    row.classList.add('active-event');
                } else {
                    row.classList.remove('active-event');
                }
            });
        }

        // Load events and update row colors
        async function loadEvents() {
            eventTableBody.innerHTML = '';

            try {
                const response = await fetch('/events');
                const eventData = await response.json();

                eventData.forEach((event, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${index + 1}</td>
                <td>${event.courseName}</td>
                <td>${event.duration}</td>
                <td>${event.startTime}</td>
                <td>${event.endTime}</td>
                <td>${event.trainerName}</td>
                <td><a href="${event.syllabusLink}" target="_blank">Link</a></td>
                <td><a href="${event.meetingLink}" target="_blank">Link</a></td>
                <td><a href="${event.studentInfoLink}" target="_blank">Link</a></td>
                <td></td>
            `;

                    const editButtonCell = row.querySelector('td:last-child');
                    const editButton = createEditButton(event);
                    const deleteButton = createDeleteButton(event);
                    editButtonCell.appendChild(editButton);
                    editButtonCell.appendChild(deleteButton);

                    eventTableBody.appendChild(row);
                });

                const eventTableContainer = document.getElementById('eventTableContainer');
                eventTableContainer.style.display = 'block';
            } catch (error) {
                console.error('Error loading events:', error);
            }

            updateRowColors();
            setInterval(updateRowColors, 1000 * 60); // Update colors every minute
        }

        loadEvents();

    </script>
</body>

</html>